# PastLead Phase 2: Contact-Centric View Implementation Plan

## 1. 目的と背景
本来の目的である「埋もれた人脈資産の発掘」を実現するため、UI構造を「スレッド単位」から「人物（Contact）単位」へ変更する。
これにより、ユーザーは「誰」との関係が途絶えているかを俯瞰し、その人物との過去のやり取り（複数のスレッド）をまとめて確認できるようになる。

## 2. 実装スコープ

### A. Backend (SQLAlchemy/FastAPI)
新しい集計ロジックとエンドポイントの実装。

1.  **集計ロジック (`services/contact_service.py` 推奨)**:
    *   `Contact` テーブルをベースに、紐づく `Thread` 情報を集計する。
    *   **キー情報**: メールアドレス + 名前 (同一人物の名寄せが理想だが、まずはメールアドレス単位)。
    *   **計算項目**:
        *   `max_score`: 全スレッドの中での最高スコア。
        *   `last_contact_date`: 全スレッド/メッセージの中での最新日時。
        *   `first_contact_date`: 全スレッド/メッセージの中での最古日時。
        *   `thread_count`: スレッド総数。
        *   `top_thread_title`: 最高スコアのスレッドの件名。
        *   `threads`: 紐づくスレッドのリスト（ID, 件名, 日時, スコア）。

2.  **APIエンドポイント (`main.py`)**:
    *   `GET /contacts`: コンタクト一覧を取得（ページネーション対応）。
        *   Sort順: デフォルトは `max_score` 降順（重要人物順）。`last_contact_date` 昇順（疎遠な人順）などでのソートも考慮。

### B. Frontend (Next.js)
トップページ (`/`) の完全リニューアル。

1.  **コンポーネント構成**:
    *   `ContactList`: メインのリストコンテナ。
    *   `ContactCard`: 各人物のブロック。アコーディオン機能を持つ。
    *   `ThreadList (embedded)`: アコーディオン展開時に表示されるスレッド一覧。

2.  **UI/UX**:
    *   **Contact Block**:
        *   名前、メールアドレス、最新/初回日時、スレッド数、最高スコアを目立つように配置。
        *   クリックで展開/折りたたみ。
    *   **Search**:
        *   従来の「スレッド検索」に加え、「人物検索」も兼ねる必要がある（または検索結果の表示をContact単位にする）。**今回はまず一覧表示の刷新に注力し、検索ロジックは既存のものをContact単位にマッピングし直すか検討が必要。** (※とりあえずは一覧刷新を優先)

## 3. 実装ステップ

### Step 1: Backend - 集計クエリの作成と検証
* `Contact` と `Thread` をJoinし、必要な集計を行うSQLAlchemyクエリを作成する。
* パフォーマンスを考慮する（N+1問題の回避、インデックス利用）。

### Step 2: Backend - APIの実装
* `GET /contacts` を実装し、JSONを返す。
* レスポンス構造の定義。

### Step 3: Frontend - API連携とリスト表示
* 新しい `Contact` 型定義を作成。
* トップページで `GET /contacts` を叩き、レンダリングする。
* アコーディオンUIの実装。

### Step 4: Frontend - 詳細遷移の接続
* アコーディオン内のスレッドをクリックした際、既存の `/thread/[id]` ページへ遷移するようにする。

## 4. 懸念事項・決定事項
* **名寄せ**: 同一人物が複数のメールアドレスを持っている場合の扱いは？ -> **Phase 2.0では「メールアドレス単位＝別人」として扱う**（シンプル化のため）。
* **パフォーマンス**: スレッド数が多い場合の集計コスト。 -> 必要であれば `Contact` テーブルに集計カラム（`cached_max_score` 等）を追加するが、まずはオンデマンド集計で試す。

## 5. スケジュール（目安）
* Backend実装: 1-2時間
* Frontend実装: 2-3時間
* 調整・テスト: 1時間
